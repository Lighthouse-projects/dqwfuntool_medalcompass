# 要件定義書
## 1. プロジェクト概要
### アプリ名
dqwfunメダルコンパス（MedalCompass）

### アプリコンセプト
- ドラクエウォークの小さなメダルの湧き位置をボタンクリックで登録、共有できる。
- 登録したメダルの湧き位置は、アプリ内のMap上に表示され、全員が参照可能。
- メダル位置は年4回（春・夏・秋・冬）のシーズンごとに管理され、過去のシーズンも閲覧可能。
- Databaseに登録されたメダルの湧き位置データは公開状態とし、誰でも参照可能。オープンデータ状態とする。
- ログイン認証は昔ながらのメールアドレス/PW方式

### ビジネス戦略
- 無料

### 収益モデル
- なし

### ターゲットユーザー
- ドラクエウォークアプリユーザ

### 想定規模
- 個人開発プロジェクト
- 目標ユーザー数: ～1,000人

## 2. 機能要件

### 2.1 基本機能
- メールアドレス/パスワードによる認証（パスワードは6文字以上）
- ログイン情報の保存（次回起動時に自動入力）
- 地図上に全ユーザーが登録したメダルを表示

#### 3つの動作モード
**探検モード**（デフォルト）
- 全メダルを金色で表示
- メダルタップで獲得/獲得キャンセル
- 獲得済みメダルはグレー表示
- 獲得日時を記録

**登録モード**
- 画面長押しでメダル登録
- 自分のメダル：金色、他人のメダル：グレー
- 自分のメダルをタップで削除
- 他人のメダルをタップで通報

**登録＆獲得モード**
- 画面長押しでメダル登録＋即座に獲得済み扱い
- 獲得済みのメダルはグレー表示
- 未獲得のメダルは金色で表示
- 未獲得メダル（金色）をタップ：獲得
- 獲得済みメダル（グレー）をタップ：自分のメダルは削除、他人のメダルは獲得キャンセル

### 2.2 獲得履歴機能
- 獲得したメダルの履歴を表示
- 獲得日時の降順で表示
- 履歴からメダルタップで地図移動
- 履歴のメダル押下中は地図上でハイライト表示
- 日付でフィルタリング可能

### 2.3 状態保存機能
- 前回のマップ位置・ズームレベルを保存
- 前回選択したモードを保存
- 次回起動時に前回の状態から開始

### 2.4 シーズン管理機能
- メダル位置は年4回（春・夏・秋・冬）のシーズンごとに管理
- シーズン表記：`YYYY/春`、`YYYY/夏`、`YYYY/秋`、`YYYY/冬`
- 初期シーズン：`2025/秋`
- マイページでシーズンを選択可能
- 選択したシーズンのメダルを地図上に表示

#### 現在シーズン（最新シーズン）
- 登録・獲得・削除・通報が可能
- モード切り替えボタンを表示
- 通常通りの全機能が利用可能

#### 過去シーズン
- 参照のみ可能（閲覧専用）
- モード切り替えボタンを非表示
- メダルの登録・獲得・削除・通報は不可
- 獲得履歴の表示は可能（過去の獲得記録を閲覧）

### 2.5 不正データ対策
- 他ユーザーのメダルを誤メダルとして通報可能
- 通報データは蓄積され、運営が確認可能
- 重複通報の防止（1ユーザーが1メダルに対して1回のみ通報可能）
- 通報履歴の保持（監査証跡として永続保存）
- メダル削除・ユーザーBAN判断は運営が手動で実施

### 2.6 ユーザー要望機能
- ユーザーが運営に要望を送信できる
- 要望のカテゴリー選択（不具合報告・機能要望・質問・その他）
- 要望内容の入力（最大500文字）
- 送信した要望の一覧表示
- 要望ごとの対応状況確認（未対応・対応中・対応完了・対応不可）
- 運営からの回答コメント表示

#### 要望カテゴリー
- **不具合報告**: アプリの不具合報告
- **機能要望**: 新機能や改善の要望
- **質問**: 使い方などの質問
- **その他**: 上記に該当しない要望

#### 対応状況
- **未対応**: まだ運営が確認していない状態
- **対応中**: 運営が対応を進めている状態
- **対応完了**: 対応が完了した状態
- **対応不可**: 対応できないと判断された状態

### 2.7 アカウント削除機能
- ユーザーが自分のアカウントを削除できる
- アカウント削除時の確認ダイアログ表示
- 削除前の警告メッセージ表示（削除後は復元不可）
- アカウント削除時に関連データも自動削除

#### 削除されるデータ
- ユーザーアカウント情報（auth.users）
- 登録したメダル（medal_medals）
- メダル獲得履歴（medal_collections）
- 通報履歴（medal_reports）
- 送信した要望（medal_requests）

#### 削除されないデータ
- なし（全てのユーザーデータを完全削除）

### 2.8 運営からのお知らせ機能
- 運営からユーザーへ重要な情報を通知できる
- メンテナンス予告、障害情報、新機能リリース等を配信
- アプリ起動時にお知らせをバナー表示
- お知らせの種類による色分け表示

#### お知らせの種類
- **情報（info）**: 新機能リリース、お知らせ等（青色）
- **警告（warning）**: 定期メンテナンス予告等（オレンジ色）
- **緊急（emergency）**: 緊急メンテナンス、障害情報等（赤色）

#### データ取得方式
**通常時（Supabase正常）:**
- データベース（medal_announcements）からお知らせを取得
- 優先度順、表示期間でフィルタリング

**障害時（Supabase接続不可）:**
- 外部API（GitHub Gist）から障害情報を取得
- フォールバック方式で可用性を確保
- `https://gist.githubusercontent.com/kikutake/125d6f997d2217d2ee0fd74ccc5a146d/raw/`

#### フォールバック仕様
```json
{
  "isDown": false,           // 障害フラグ（true時に障害メッセージ表示）
  "message": "",             // 障害メッセージ
  "updatedAt": "YYYY-MM-DDTHH:mm:ssZ"  // 更新日時
}
```

#### 表示制御
**通常時（Supabase正常）:**
- **緊急（emergency）のお知らせがある場合のみ**、マップ画面上部にバナー表示
- 情報（info）や警告（warning）のお知らせはバナー表示しない（お知らせ一覧画面でのみ表示）
- バナータップでお知らせ一覧画面へ遷移
- バナーは×ボタンで閉じられる（アプリ再起動で再表示）
- 緊急お知らせがない場合はバナー非表示

**お知らせ一覧への導線:**
- マイページの「お知らせ」リンクからアクセス可能
- 緊急・警告のお知らせがある場合、バッジで件数表示（例：🔴 2）
- バッジには緊急＋警告の合計件数を表示
- お知らせがない場合（情報のみの場合も含む）はバッジ非表示

**障害時（Supabase接続不可）:**
- ログイン画面に障害メッセージを全画面表示
- GitHub Gistから取得した障害情報を表示
- ログインフォームは非表示（認証不可のため）
- 更新日時を表示してユーザーに最新情報を提示

## 3. 非機能要件
### 3.1 パフォーマンス
- アプリ起動時間: 3秒以内

### 3.2 セキュリティ
- **DBのデータ保護**:
  - データ登録、削除はRow Level Security (RLS)により、認証済みユーザのみ自分のデータを操作可能とする。
  - データ参照はクライアント端末からSupabaseのpublicスキーマのデータを直接参照可能とする（全員閲覧可能）。
- **データ暗号化**:
  - パスワード：Supabase保存時のハッシュ化（bcrypt等）
  - 個人情報：存在しない
  - 通信：HTTPS/TLS暗号化
- **プライバシー保護**:
  - 位置情報の適切な管理（おおまかな地域のみ表示）
  - 個人を特定できる情報の厳重管理


### 3.3 スケーラビリティ
- 1,000人のアクティブユーザーに対応

### 3.4 運営・保守
- **サポート体制**: 個人のベストエフォート
- **システム監視**: 個人のベストエフォート
- **データバックアップ**: 日次自動バックアップ
- **セキュリティ監視**: 個人のベストエフォート

### 3.5 UI/UX要件
- **デザイン方針**: 一般的なマップアプリにメダルが表示されている、登録ボタンのみの超シンプルUIUX。歩きながら使うアプリなので大きいボタン。
- **基本画面構成**: 地図画面
- **操作性**: 直感的な地図操作と登録操作
- **レスポンシブデザイン**: iOS/Android両対応
- **アクセシビリティ**: 特別な配慮は行わない（標準レベル）

### 3.6 データ管理要件
- **データ保存期間**: 後日検討
- **バックアップ方針**: 日次自動バックアップのみ実装
- **GDPR等海外対応**: 現段階では考慮対象外（日本国内向けサービスとして開始）
- **データ削除**: ユーザーアカウント削除時の基本的なデータ削除のみ実装

## 4. 法的・運営上の注意事項

### 4.1 法的コンプライアンス
- ドラクエウォークの利用規約を破らないこと。あくまでもファンツール。

### 4.2 コンテンツモデレーション
- 文字情報は登録不可のため考慮不要
- 不正なメダル登録に対しては、ユーザーコミュニティによる「誤メダル」通報機能で対応
- 通報機能の悪用（虚偽通報）に対しては、管理者による手動対応

### 4.3 カスタマーサポート体制
- **チャットサポート**: githubのIssueによる問い合わせ
- **対応内容**: 諸々
- **対応言語**: 日本語のみ
- **レスポンス目標**: 個人開発のためベストエフォート
